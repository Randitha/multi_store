<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Reporting Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Animated background gradient */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.1) 0%, 
                rgba(118, 75, 162, 0.1) 100%);
            z-index: -1;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .container {
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.15), 
                        0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 35px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: moveBackground 20s linear infinite;
        }
        
        @keyframes moveBackground {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 800;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.15rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .main-content {
            display: grid;
            grid-template-columns: 0.7fr 1.3fr;
            gap: 30px;
            padding: 40px;
        }

        .suggestions-section {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .chat-section {
            background: #ffffff;
            border-radius: 16px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            height: 75vh;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .suggestion-item {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .suggestion-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .suggestion-item:hover {
            background: linear-gradient(135deg, #f9fafb 0%, #f1f5f9 100%);
            border-color: #4f46e5;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
        }
        
        .suggestion-item:hover::before {
            transform: scaleY(1);
        }

        .suggestion-item:last-child {
            margin-bottom: 0;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 85%;
            line-height: 1.6;
        }

        .user-message {
            background: #4f46e5;
            color: white;
            margin-left: auto;
        }

        .assistant-message {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 16px;
            color: #1f2937;
            margin-right: auto;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #4f46e5;
            max-width: 100%;
            margin-bottom: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .assistant-message .content {
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.7;
        }
        
        .assistant-message .content strong {
            color: #1e293b;
            font-weight: 700;
        }

        /* Streaming indicator */
        .streaming-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Loading Message Styles */
        .loading-message {
            background: #f1f5f9;
            padding: 12px;
            color: #1f2937;
            margin-right: auto;
            border: 1px solid #e2e8f0;
            max-width: 100%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .thinking-loader {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .generating-loader {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .input-section {
            display: flex;
            gap: 10px;
        }

        .question-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .question-input:focus {
            border-color: #4f46e5;
        }

        .ask-button, .clear-button {
            padding: 14px 24px;
            background: linear-gradient(135deg, #4f46e5, #4338ca);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .ask-button:hover {
            background: linear-gradient(135deg, #4338ca, #3730a3);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
        }

        .ask-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .clear-button {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .clear-button:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #fecaca;
            margin-bottom: 15px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .refresh-button {
            background: none;
            border: none;
            color: #4f46e5;
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: auto;
        }

        .refresh-button:hover {
            color: #3730a3;
        }

        /* Enhanced Chart styles */
        .chart-container {
            margin-top: 15px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            width: 100%;
            min-height: 400px;
            position: relative;
        }

        /* Make sure all chart types render properly */
        .chart-container canvas {
            display: block !important;
            width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            min-height: 350px !important;
        }

        .chart-container > div {
            width: 100% !important;
            min-height: 400px !important;
            position: relative;
        }

        .chart-container svg {
            max-width: 100% !important;
            height: auto !important;
            min-height: 350px !important;
        }
        
        .generate-chart-btn {
            margin-top: 12px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .generate-chart-btn:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        
        .generate-chart-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .chart-error {
            color: #dc2626;
            padding: 10px;
            background-color: #fef2f2;
            border-radius: 6px;
            border: 1px solid #fecaca;
            margin: 10px 0;
        }

        /* Connection status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-status.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .connection-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                height: calc(100vh - 100px);
            }
            
            .header {
                padding: 15px 20px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .suggestions-section {
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
                height: auto;
                max-height: 200px;
                padding: 15px;
            }

            .chat-section {
                padding: 20px;
                height: calc(100vh - 300px);
            }

            .chat-history {
                height: calc(100vh - 400px);
                padding: 20px;
            }

            .chart-container {
                padding: 15px;
                min-height: 300px;
            }

            .chart-container canvas {
                min-height: 250px !important;
            }
        }
    </style>
</head>
<body>    <!-- Connection status indicator -->
    <div class="connection-status disconnected" id="connection-status">
        <span class="status-dot"></span>
        <span id="status-text">Connecting...</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>ðŸ¤– AI Reporting Agent</h1>
            <p>Ask natural language questions about your data and get AI-powered insights with real-time streaming</p>
        </div>
        
        <div class="main-content">
            <!-- Suggestions Section -->
            <div class="suggestions-section">
                <div class="section-title" id="suggestions-title">
                    <span>ðŸ’¡ Suggested Questions</span>
                    <button class="refresh-button" id="refresh-suggestions" title="Refresh suggestions">â†»</button>
                    <div class="loading-spinner" id="suggestions-loading" style="display: none;"></div>
                </div>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="suggestions-status">Loading suggestions...</span>
                </div>
                <div id="suggestions-container"></div>
            </div>

            <!-- Chat Section -->
            <div class="chat-section">
                <div class="section-title">
                    ðŸ’¬ Chat with AI
                </div>
                
                <div id="error-container"></div>
                
                <div class="chat-history" id="chat-history">
                    <div class="assistant-message">
                        <strong>AI Assistant:</strong> Hello! I'm here to help you analyze your data with real-time streaming responses. Ask me questions about visitor counts, demographics, trends, and more. Try one of the suggested questions or ask your own!
                    </div>
                </div>
                
                <div class="input-section">
                    <input 
                        type="text" 
                        id="question-input" 
                        class="question-input" 
                        placeholder="Ask a question about your data..."
                        maxlength="500"
                    >
                    <button id="ask-button" class="ask-button">Ask</button>
                    <button id="clear-button" class="clear-button">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API base URL
        const API_BASE_URL = window.location.origin;

        // Initialize Socket.IO connection
        let socket = null;
        let isStreaming = false;
        let currentStreamingMessage = null;

        // DOM elements
        const suggestionsContainer = document.getElementById('suggestions-container');
        const chatHistory = document.getElementById('chat-history');
        const questionInput = document.getElementById('question-input');
        const askButton = document.getElementById('ask-button');
        const clearButton = document.getElementById('clear-button');
        const errorContainer = document.getElementById('error-container');
        const suggestionsStatus = document.getElementById('suggestions-status');
        const suggestionsLoading = document.getElementById('suggestions-loading');
        const refreshSuggestionsButton = document.getElementById('refresh-suggestions');
        const connectionStatus = document.getElementById('connection-status');
        const statusText = document.getElementById('status-text');

        // State
        let isLoading = false;
        let currentLoadingMessage = null;

        // Initialize Socket.IO
        function initializeSocket() {
            socket = io(API_BASE_URL, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5
            });

            socket.on('connect', () => {
                console.log('Connected to server');
                updateConnectionStatus(true);
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateConnectionStatus(false);
            });

            socket.on('connected', (data) => {
                console.log('Server acknowledged connection:', data);
            });

            socket.on('stream_chunk', (data) => {
                if (data.chunk && currentStreamingMessage) {
                    appendToStreamingMessage(data.chunk);
                }
            });

            socket.on('stream_complete', () => {
                finalizeStreamingMessage();
            });

            socket.on('complete_response', async (data) => {
                // This is sent after streaming is complete
                console.log('Complete response received:', data);
                
                // Refresh suggestions after getting response with a small delay
                setTimeout(async () => {
                    await loadSuggestions();
                }, 500);
            });

            socket.on('error', (data) => {
                console.error('Socket error:', data);
                removeLoadingMessage();
                displayError(data.error || 'An error occurred');
                isStreaming = false;
                isLoading = false;
                askButton.disabled = false;
                askButton.textContent = 'Ask';
            });
        }

        // Update connection status UI
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.className = 'connection-status connected';
                statusText.textContent = 'Connected';
            } else {
                connectionStatus.className = 'connection-status disconnected';
                statusText.textContent = 'Disconnected';
            }
        }
        // Function to start streaming message
        function startStreamingMessage() {
            removeLoadingMessage();
            
            const messageElement = document.createElement('div');
            messageElement.className = 'assistant-message';
            messageElement.id = 'streaming-message';
            messageElement.innerHTML = `
                <strong>AI Assistant:</strong>
                <span class="streaming-indicator"></span>
                <div class="content"></div>
            `;
            
            chatHistory.appendChild(messageElement);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            currentStreamingMessage = messageElement;
            isStreaming = true;
        }

        // Function to append to streaming message
        function appendToStreamingMessage(chunk) {
            if (!currentStreamingMessage) return;
            
            const contentDiv = currentStreamingMessage.querySelector('.content');
            if (contentDiv) {
                contentDiv.textContent += chunk;
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }

        // Function to finalize streaming message
        function finalizeStreamingMessage() {
            if (!currentStreamingMessage) return;
            
            // Remove streaming indicator
            const indicator = currentStreamingMessage.querySelector('.streaming-indicator');
            if (indicator) {
                indicator.remove();
            }
            
            // Format the content with markdown
            const contentDiv = currentStreamingMessage.querySelector('.content');
            if (contentDiv) {
                const rawText = contentDiv.textContent;
                contentDiv.innerHTML = formatText(rawText);
                
                // Check if response has chart potential
                const chartKeywords = ['trend', 'comparison', 'percentage', 'distribution', 'growth', 'change', 
                                      'average', 'total', 'count', 'peak', 'highest', 'lowest', 'ratio'];
                const hasChartPotential = chartKeywords.some(keyword => 
                    rawText.toLowerCase().includes(keyword)
                );
                
                // Add chart generation button if applicable
                if (hasChartPotential && !rawText.toLowerCase().includes("don't have enough data")) {
                    const chartButton = document.createElement('button');
                    chartButton.className = 'generate-chart-btn';
                    chartButton.textContent = 'ðŸ“Š Generate Chart';
                    chartButton.onclick = function() {
                        generateChartForResponse(rawText, this);
                    };
                    currentStreamingMessage.appendChild(chartButton);
                }
            }
            
            currentStreamingMessage = null;
            isStreaming = false;
            isLoading = false;
            askButton.disabled = false;
            askButton.textContent = 'Ask';
        }

        // Function to add loading message to chat
        function addLoadingMessage(type = 'thinking') {
            removeLoadingMessage();
            
            const loadingElement = document.createElement('div');
            loadingElement.className = 'loading-message';
            loadingElement.id = 'current-loading';
            
            const loader = document.createElement('div');
            loader.className = type === 'thinking' ? 'thinking-loader' : 'generating-loader';
            
            const text = document.createElement('span');
            text.textContent = type === 'thinking' ? 'AI is thinking...' : 'Generating chart...';
            
            loadingElement.appendChild(loader);
            loadingElement.appendChild(text);
            
            chatHistory.appendChild(loadingElement);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            currentLoadingMessage = loadingElement;
        }

        // Function to remove loading message
        function removeLoadingMessage() {
            if (currentLoadingMessage && currentLoadingMessage.parentNode) {
                currentLoadingMessage.parentNode.removeChild(currentLoadingMessage);
                currentLoadingMessage = null;
            }
        }

        // Function to display error
        function displayError(message) {
            const errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            errorElement.textContent = `Error: ${message}`;
            errorContainer.appendChild(errorElement);
            
            setTimeout(() => {
                if (errorElement.parentNode) {
                    errorElement.parentNode.removeChild(errorElement);
                }
            }, 5000);
        }

        // Function to format text with bold and line breaks
        function formatText(text) {
            if (typeof text !== 'string') return text;
            
            // Replace escaped newlines with actual newlines
            let formatted = text.replace(/\\n/g, '\n');
            
            // Convert markdown bold (**text**) to HTML <strong>
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert markdown bullet points (* item) to HTML with proper line breaks
            formatted = formatted.replace(/^\* (.+)$/gm, 'â€¢ $1<br>');
            
            // Convert standalone bold headers (lines that start with **) to have line breaks before them
            formatted = formatted.replace(/\n(\*\*[^*]+\*\*:?)/g, '<br><br>$1');
            
            // Convert double newlines to paragraph breaks
            formatted = formatted.replace(/\n\n/g, '<br><br>');
            
            // Convert single newlines to line breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }

        // Function to initialize charts after they are added to DOM
        function initializeChart(chartContainer) {
            setTimeout(() => {
                const canvases = chartContainer.querySelectorAll('canvas');
                canvases.forEach(canvas => {
                    canvas.style.display = 'block';
                    canvas.style.visibility = 'visible';
                    canvas.style.opacity = '1';
                });

                const scripts = chartContainer.querySelectorAll('script');
                scripts.forEach(script => {
                    try {
                        const scriptContent = script.textContent || script.innerHTML;
                        
                        if (scriptContent.includes('new Chart') || scriptContent.includes('Chart.')) {
                            const newScript = document.createElement('script');
                            const wrappedScript = `
                            try {
                                ${scriptContent}
                            } catch (chartError) {
                                console.error('Chart initialization error:', chartError);
                                setTimeout(() => {
                                    try {
                                        ${scriptContent}
                                    } catch (retryError) {
                                        console.error('Chart retry failed:', retryError);
                                    }
                                }, 100);
                            }
                            `;
                            
                            newScript.textContent = wrappedScript;
                            document.head.appendChild(newScript);
                            setTimeout(() => {
                                if (document.head.contains(newScript)) {
                                    document.head.removeChild(newScript);
                                }
                            }, 1000);
                        }
                    } catch (error) {
                        console.error('Error executing chart script:', error);
                    }
                });

                setTimeout(() => {
                    if (typeof Chart !== 'undefined' && Chart.instances) {
                        Object.values(Chart.instances).forEach(chart => {
                            try {
                                chart.resize();
                                chart.update();
                            } catch (e) {
                                console.log('Chart update error:', e);
                            }
                        });
                    }
                    window.dispatchEvent(new Event('resize'));
                }, 200);

            }, 100);
        }
        // Initialize the application
        async function init() {
            console.log('Initializing application...');
            
            try {
                // Initialize socket first
                initializeSocket();
                
                // Load chat history
                await loadChatHistory();
                
                // Setup event listeners
                setupEventListeners();
                
                // Load suggestions with retry mechanism
                let retries = 3;
                while (retries > 0) {
                    try {
                        await loadSuggestions();
                        break; // Success, exit retry loop
                    } catch (error) {
                        retries--;
                        if (retries === 0) {
                            console.error('Failed to load suggestions after retries, using defaults');
                            displayDefaultSuggestions();
                        } else {
                            console.log(`Retrying suggestions load... (${retries} retries left)`);
                            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
                        }
                    }
                }
                
                console.log('Application initialized successfully');
            } catch (error) {
                console.error('Error during initialization:', error);
                // Ensure we have some suggestions even if init fails
                displayDefaultSuggestions();
            }
        }

        // Load chat history from the API
        async function loadChatHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/store/chat-history`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.store_history && data.store_history.length > 0) {
                        chatHistory.innerHTML = '';
                        
                        data.store_history.forEach(item => {
                            if (item.type === 'user') {
                                addMessageToChat(item.message, 'user');
                            } else {
                                addMessageToChat(
                                    item.message, 
                                    'assistant', 
                                    item.chart_html || null,
                                    item.has_chart_potential || false
                                );
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        // Load suggestions from the API
        async function loadSuggestions() {
            try {
                suggestionsLoading.style.display = 'block';
                suggestionsStatus.textContent = 'Loading suggestions...';
                
                const response = await fetch(`${API_BASE_URL}/store/suggestions`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.suggested_questions && Array.isArray(data.suggested_questions)) {
                    const suggestionType = data.contextual ? 'contextual' : 'default';
                    suggestionsStatus.textContent = `${data.suggested_questions.length} ${suggestionType} suggestions loaded (${data.generation_time})`;
                    displaySuggestions(data.suggested_questions);
                } else {
                    throw new Error('Invalid suggestions format');
                }
            } catch (error) {
                console.error('Error loading suggestions:', error);
                suggestionsStatus.textContent = 'Using default suggestions';
                displayDefaultSuggestions();
            } finally {
                suggestionsLoading.style.display = 'none';
            }
        }

        // Display suggestions in the UI
        function displaySuggestions(suggestions) {
            suggestionsContainer.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const suggestionElement = document.createElement('div');
                suggestionElement.className = 'suggestion-item';
                suggestionElement.textContent = suggestion;
                suggestionElement.addEventListener('click', () => {
                    questionInput.value = suggestion;
                    questionInput.focus();
                });
                suggestionsContainer.appendChild(suggestionElement);
            });
        }

        // Display default suggestions if API fails
        function displayDefaultSuggestions() {
            const defaultSuggestions = [
                "What was the total visitor count yesterday?",
                "How has foot traffic changed over the past week?",
                "What is the age distribution of our visitors?",
                "What percentage of visitors were female?",
                "What are the peak hours for visitor traffic?"
            ];
            displaySuggestions(defaultSuggestions);
        }

        // Add message to chat
        function addMessageToChat(message, type, chartHtml = null, hasChartPotential = false) {
            if (type === 'assistant') {
                removeLoadingMessage();
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${type}-message`;
            
            if (type === 'user') {
                messageElement.innerHTML = `<strong>You:</strong> ${message}`;
            } else {
                const formattedMessage = formatText(message);
                messageElement.innerHTML = `
                    <strong>AI Assistant:</strong> 
                    <div class="content">${formattedMessage}</div>
                `;
                
                if (chartHtml && chartHtml.trim()) {
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'chart-container';
                    chartContainer.innerHTML = chartHtml;
                    messageElement.appendChild(chartContainer);
                    
                    setTimeout(() => initializeChart(chartContainer), 50);
                } else {
                    // Check if this message has chart potential
                    const chartKeywords = ['trend', 'comparison', 'percentage', 'distribution', 'growth', 'change',
                                          'average', 'total', 'count', 'peak', 'highest', 'lowest', 'ratio'];
                    const shouldShowButton = hasChartPotential || chartKeywords.some(keyword => 
                        message.toLowerCase().includes(keyword)
                    );
                    
                    if (shouldShowButton && !message.toLowerCase().includes("don't have enough data")) {
                        const chartButton = document.createElement('button');
                        chartButton.className = 'generate-chart-btn';
                        chartButton.textContent = 'ðŸ“Š Generate Chart';
                        chartButton.onclick = function() {
                            generateChartForResponse(message, this);
                        };
                        messageElement.appendChild(chartButton);
                    }
                }
            }
            
            chatHistory.appendChild(messageElement);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        // Generate chart for a response
        async function generateChartForResponse(answer, buttonElement) {
            try {
                buttonElement.disabled = true;
                buttonElement.textContent = 'Generating...';
                
                addLoadingMessage('generating');
                
                const messages = chatHistory.querySelectorAll('.chat-message');
                let question = '';
                
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].classList.contains('user-message')) {
                        question = messages[i].textContent.replace('You:', '').trim();
                        break;
                    }
                }
                
                const response = await fetch(`${API_BASE_URL}/store/generate-chart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        question: question,
                        answer: answer 
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                removeLoadingMessage();

                if (data.chart_html && data.chart_html.trim()) {
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'chart-container';
                    chartContainer.innerHTML = data.chart_html;
                    
                    buttonElement.parentNode.replaceChild(chartContainer, buttonElement);
                    
                    setTimeout(() => {
                        initializeChart(chartContainer);
                        
                        setTimeout(() => {
                            const canvases = chartContainer.querySelectorAll('canvas');
                            canvases.forEach(canvas => {
                                if (canvas.offsetHeight === 0) {
                                    console.log('Canvas has zero height, forcing resize');
                                    canvas.style.height = '350px';
                                    canvas.style.minHeight = '350px';
                                    
                                    if (typeof Chart !== 'undefined') {
                                        const chartId = canvas.id;
                                        if (chartId && Chart.instances) {
                                            const chartInstance = Object.values(Chart.instances).find(
                                                chart => chart.canvas.id === chartId
                                            );
                                            if (chartInstance) {
                                                chartInstance.resize();
                                                chartInstance.update();
                                            }
                                        }
                                    }
                                }
                            });
                        }, 500);
                    }, 150);
                } else {
                    throw new Error('No chart data received');
                }
                
            } catch (error) {
                console.error('Error generating chart:', error);
                removeLoadingMessage();
                buttonElement.disabled = false;
                buttonElement.textContent = 'Generate Chart';
                
                const errorElement = document.createElement('div');
                errorElement.className = 'chart-error';
                errorElement.textContent = `Error generating chart: ${error.message}`;
                buttonElement.parentNode.appendChild(errorElement);
            }
        }

        // Ask question using WebSocket
        async function askQuestion() {
            const question = questionInput.value.trim();
            if (!question) return;

            if (isLoading || isStreaming) return;

            if (!socket || !socket.connected) {
                displayError('Not connected to server. Please wait...');
                return;
            }

            try {
                isLoading = true;
                askButton.disabled = true;
                askButton.textContent = 'Asking...';
                
                errorContainer.innerHTML = '';
                
                // Add user message to chat
                addMessageToChat(question, 'user');
                
                // Clear input
                questionInput.value = '';

                // Add thinking loading message
                addLoadingMessage('thinking');

                // Start streaming message
                setTimeout(() => {
                    startStreamingMessage();
                }, 500);

                // Send question via WebSocket
                socket.emit('ask_question', { question: question });

            } catch (error) {
                console.error('Error asking question:', error);
                removeLoadingMessage();
                displayError(error.message);
                isLoading = false;
                isStreaming = false;
                askButton.disabled = false;
                askButton.textContent = 'Ask';
            }
        }

        // Clear chat history
        async function clearChatHistory() {
            if (!confirm('Are you sure you want to clear the chat history? This will also reset the suggestions.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/store/clear-history`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                chatHistory.innerHTML = `
                    <div class="assistant-message">
                        <strong>AI Assistant:</strong> Hello! I'm here to help you analyze your data with real-time streaming responses. Ask me questions about visitor counts, demographics, trends, and more. Try one of the suggested questions or ask your own!
                    </div>
                `;
                errorContainer.innerHTML = '';
                
                await loadSuggestions();
                
            } catch (error) {
                console.error('Error clearing chat history:', error);
                displayError('Failed to clear chat history. Please try again.');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            askButton.addEventListener('click', askQuestion);
            clearButton.addEventListener('click', clearChatHistory);
            refreshSuggestionsButton.addEventListener('click', loadSuggestions);
            
            questionInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    askQuestion();
                }
            });
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>